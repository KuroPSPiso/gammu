#include <gb/gb.h>
#include <stdint.h>
#include "alpha.c"

#define TRUE 1
#define FALSE 0

#define FT 0 //floor tile
#define WT 1 //wall tile

//global variables
UINT8 modMultiplier = 0x00;
UINT8 test = 1;
UINT16 playerX = 00;
UINT16 playerY = 00;
UINT8 updateScreen = TRUE;
UINT8 tick = 0x00;
UINT8 scanline_x = 0x00;

unsigned char vramData[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile A1 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile A2 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile A3 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile A4 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile B1 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile B2 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile B3 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile B4 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile C1 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile C2 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile C3 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile D4 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile D1 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile D2 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile D3 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //tile D4 (16bytes)
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char vramTiles[] = {
//	A	  B		C     D
	0x40, 0x44, 0x48, 0x4C, //1
	0x41, 0x45, 0x49, 0x4D, //2
	0x42, 0x46, 0x4A, 0x4E, //3
	0x43, 0x47, 0x4B, 0x4F  //4
};

//constants
const char map[] = {
	WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,
	WT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,WT,
	WT,FT,FT,WT,FT,FT,FT,FT,FT,FT,FT,FT,WT,FT,FT,WT,
	WT,FT,WT,WT,FT,FT,FT,FT,FT,FT,FT,FT,WT,WT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,WT,FT,WT,FT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,WT,FT,WT,FT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,WT,WT,FT,WT,WT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,WT,WT,WT,FT,FT,FT,WT,WT,WT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,WT,WT,WT,FT,FT,FT,WT,WT,WT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,WT,WT,FT,WT,WT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,WT,FT,WT,FT,FT,FT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,WT,FT,WT,FT,FT,FT,FT,FT,WT,
	WT,FT,WT,WT,FT,FT,FT,FT,FT,FT,FT,FT,WT,WT,FT,WT,
	WT,FT,FT,WT,FT,FT,FT,FT,FT,FT,FT,FT,WT,FT,FT,WT,
	WT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,FT,WT,
	WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT,WT
};

//implicit methods
UINT8 pixColour(UINT8 px);
UINT8 mod(UINT8 a, UINT8 divider);

//methods
void clearScreen()
{
	set_bkg_tiles(0, 0, 20, 18, blankScreen);
}

void renderGraphics()
{
	set_bkg_data(0x40, 16, vramData);
	set_bkg_tiles(40, 38, 4, 4, vramTiles);
}

void computeVerticalLine()
{
	//TODO:
	// - Optimize(check for reoccuring tiles), 
	//   at cost of temp performance for multiple loops)
	// - Optimize = scalable

	UINT8 scanline_y;
	for (scanline_y = 0; scanline_y < 8 * 4; scanline_y++) {
		UINT8 x = mod(scanline_x, 8);
		UINT8 x_pixel = mod(scanline_x, 4);
		UINT8 x_second = mod(scanline_x, 2);
		UINT8 xOffset = scanline_x / 8;
		xOffset = 16 * xOffset;
		xOffset = 4 * xOffset;
		if (x == 0)
		{
			vramData[xOffset + x + scanline_y * 2] = 0x00;
			vramData[xOffset + x + 1 + scanline_y * 2] = 0x00;
		}

		vramData[xOffset + x + scanline_y * 2] = 0xFF;
		vramData[xOffset + x + 1 + scanline_y * 2] = 0xFF;
	}

	renderGraphics();
}

void computeGraphics()
{

	computeVerticalLine();

	/*
	if (mod(scanline_x, 4) == 0)
	{
		//renderGraphics();
	}*/

	if (scanline_x < 8 * 4) scanline_x++;
	else scanline_x = 0x00;
}

void init()
{
	DISPLAY_ON;		// Turn on the display
	NR52_REG = 0x8F;	// Turn on the sound
	NR51_REG = 0x11;	// Enable the sound channels
	NR50_REG = 0x77;	// Increase the volume to its max

	set_bkg_data(0, 47, alpha);		// Load 47 tiles into background memory

	unsigned char bug1[] = {
		0xFF,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00, //tile 1
		0xFF,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,
	};
	unsigned char bug2[] = {
		0x00,0x00,0x88,0x88,0x00,0x00,0x88,0x88,//tile 1
		0x00,0x00,0x88,0x88,0x00,0x00,0x88,0x88,
	};
	set_bkg_data(0xFF, 1, bug1);
	//set_bkg_data(0x30, 1, bug2);
}


void checkInput() {
	if (joypad() & J_A) {
		// The B button was pressed!
		//set_bkg_tiles(0, 6, 10, 2, helloWorld);
		computeGraphics();
	}
	if (joypad() & J_B) {
		// The B button was pressed!
		clearScreen();
	}
}

void updateSwitches() {
	HIDE_WIN;
	SHOW_SPRITES;
	SHOW_BKG;
}

/*
void renderFrame()
{

	//todo renderArray

	unsigned char data1[] = {
		tick, tick+2, tick+4, tick+6
	};
	unsigned char data2[] = {
		tick+1, tick + 3, tick + 5, tick + 7
	};
	unsigned char data3[] = {
		tick+2, tick + 4, tick + 6, tick + 8
	};
	unsigned char data4[] = {
		tick+3, tick + 5, tick + 7, tick + 9
	};

	set_bkg_data(50, 1, data1);
	set_bkg_data(51, 1, data2);
	set_bkg_data(52, 1, data3);
	set_bkg_data(53, 1, data4);
	tick ++;
	//set_data(vramaddy, data, len);

	//get_data(data, vramaddy,  len);
}*/

void main(void)
{
	init();
	clearScreen();
    // Loop forever
    while(1) {

		checkInput();
		updateSwitches();

		// Game main loop processing goes here
		computeGraphics();
		//renderFrame();

		// Done processing, yield CPU and wait for start of next frame
        wait_vbl_done();
    }
}

UINT8 pixColour(UINT8 px)
{
	if (px == 0) return 0x80;
	if (px == 1) return 0x40;
	if (px == 2) return 0x20;
	if (px == 3) return 0x10;

	return 0x00;
}

UINT8 mod(UINT8 a, UINT8 divider)
{
	if (divider == 0) return 0;
	modMultiplier = a / divider;
	return a - divider * modMultiplier;
}